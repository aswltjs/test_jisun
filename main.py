from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import FileResponse, HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
import uvicorn

# 템플릿 디렉토리 설정
templates = Jinja2Templates(directory="templates")

app = FastAPI()

from fastapi import FastAPI

app = FastAPI()



@app.get("/result.html", response_class=HTMLResponse)
async def get_result_page(request: Request):
    try:
        return templates.TemplateResponse("result.html", {"request": request})
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


# 정적 파일 제공 설정
app.mount("/static", StaticFiles(directory="static", html=True), name="static")

@app.get("/favicon.ico")
async def get_favicon():
    return FileResponse("static/favicon.ico")

@app.get("/", response_class=HTMLResponse)
async def read_index(request: Request):
    try:
        return templates.TemplateResponse("index.html", {"request": request})
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

class SurveyAnalyzer:
    def __init__(self):
        # 질문과 점수 설정
        self.questions = {
            "생리적 욕구": [
                ("하루에 몇 번의 식사를 하시나요?", {
                    "3번": (0, "규칙적인 식사 습관을 가진 경우. 이는 영양 공급이 적절하게 이루어지며, 신체 리듬이 안정적임을 의미합니다."),
                    "2번": (1, "덜 규칙적이지만 어느 정도의 일관성을 가진 식사 습관. 이 경우 에너지 수준이 일정하지 않을 수 있습니다."),
                    "1번": (2, "매우 불규칙한 식사 습관으로, 영양 불균형 및 에너지 부족, 체력 저하를 초래할 수 있습니다.")
                }),
                ("평균적으로 몇 시간의 수면을 하시나요?", {
                    "1~4시간": (2, "심각한 수면 부족. 이는 집중력 저하, 면역력 약화, 감정 기복 등을 유발할 수 있습니다."),
                    "6~8시간": (0, "적절한 수면 시간. 이는 건강한 신체 기능 유지, 기분 안정 및 전반적인 건강 유지에 도움이 됩니다."),
                    "10~14시간": (1, "과도한 수면. 이는 반대로 피로감, 무기력감, 신체 리듬 교란을 일으킬 수 있습니다.")
                }),
                ("일주일에 주 몇 회 운동을 하시나요?", {
                    "3회 이상": (0, "활발한 운동 습관. 이는 체력 유지, 스트레스 해소, 심혈관 건강 증진에 매우 긍정적입니다."),
                    "1회 이상": (1, "보통의 운동 습관. 이는 기본적인 건강 유지에 도움이 되지만, 좀 더 운동량을 늘리는 것이 바람직합니다."),
                    "하지 않음": (2, "운동 부족. 이는 체력 저하, 비만, 심혈관 질환 등의 위험을 높일 수 있습니다.")
                }),
                ("당신은 요즘 감정 기복이 좋았다가 나빴다가를 반복하는 편인가요?", {
                    "그런편이다.": (1, "감정 기복이 심함. 이는 스트레스, 불안, 우울증 등의 정신 건강 문제를 시사할 수 있습니다."),
                    "그렇지 않다.": (0, "감정이 안정적임. 이는 정신적으로 안정된 상태를 의미합니다."),
                }),
                ("집에 혼자 있을 때 주로 어떤 쪽으로 시간을 보내나요?", {
                    "자기개발": (0, "생산적이고 긍정적인 활동. 이는 자기 만족도와 자아실현에 긍정적인 영향을 줍니다."),
                    "휴식": (0, "중립적인 활동. 이는 스트레스 해소와 체력 회복에 도움이 됩니다."),
                }),
                ("당신이 주로 기분 전환으로 하는 행동과 가까운 것은 어느 쪽인가요?", {
                    "운동 및 드라이브나 야외활동": (0, "스트레스 해소에 효과적. 이는 신체 활동을 통해 스트레스를 해소하는 건강한 방법입니다."),
                    "영화, 음악감상 등 집에서 취미활동.": (0, "스트레스 해소에 도움. 이는 정신적 휴식을 제공하며 기분 전환에 도움이 됩니다."),
                    "아무것도 하지 않는다.": (1, "스트레스 해소에 비효율적. 이는 문제를 해결하지 않고 회피하는 경향을 나타낼 수 있습니다."),
                }),
                ("하루에 직장에서의 지내는 시간은 어느 정도인가요?", {
                    "8시간 이하": (0, "적절한 근무 시간. 이는 일과 삶의 균형을 유지하는 데 도움이 됩니다."),
                    "8시간 이상": (1, "장시간 근무. 이는 과로로 인한 스트레스, 피로, 건강 문제를 초래할 수 있습니다"),
                    "직장을 다니지 않음": (1, "경제적 불안정성, 사회적 고립감, 규칙적인 생활 패턴의 부족으로 인한 일과 삶의 균형의 도전 요소가 있을 수 있습니다."),
                }),
                ("하루에 집에서 보내는 시간은 어느 정도인가요?", {
                    "12시간 이하": (0, "균형 잡힌 생활. 이는 사회 활동과 휴식을 적절히 배분하는 건강한 생활 패턴입니다."),
                    "24시간": (1, "매우 불균형한 생활. 이는 사회적 고립, 신체 활동 부족 등의 문제를 유발할 수 있습니다."),
                }),
            ],
            "안전보호의 욕구": [
                ("당신은 새로운 도전을 하는 것과 기존의 안정함을 유지하는 것 중에 어떤 타입인가요?", {
                    "새로운 도전": (0, "모험적이고 변화를 선호하는 성향입니다. 이는 성장과 발전을 추구하지만, 불확실성으로 인한 스트레스를 경험할 수 있습니다."),
                    "기존의 안정함 유지": (0, "안정적이고 예측 가능한 환경을 선호하는 성향입니다. 이는 스트레스가 적지만, 변화와 성장 기회를 놓칠 수 있습니다"),
                }),
                ("당신은 생각지도 못한 일이 생겼을 때 어떻게 대처하는 편인가요?", {
                    "새로운 도전": (1, "독립적인 문제 해결 방식을 선호하지만, 스트레스가 높아질 수 있습니다."),
                    "기존의 안정함 유지": (0, "협력적인 문제 해결 방식을 선호하며, 스트레스가 덜할 수 있습니다."),
                }),
                ("내가 일을 하면서 혹은 일을 시작하려고 할 때 더 중요하게 느끼는 부분이 더 가까운 것은 어떤 것인가요?", {
                    "성취감에서 오는 보상": (0, "목표 달성과 성취를 중요시하며, 자아실현을 중시하는 성향입니다."),
                    "안정적인 수익과 생활": (0, "재정적 안정과 예측 가능한 생활을 중시하는 성향입니다."),
                }),
                ("당신이 요즘 신경을 쓰는 것과 가까운 쪽은?", {
                    "건강": (0, "신체적 및 정신적 건강 유지에 중점을 둡니다."),
                    "금전": (0, "재정적 안정과 예측 가능한 생활을 중시하는 성향입니다."),
                    "인간관계": (0, "사회적 유대 강화와 관계 개선을 중시."),
                }),
                ("당신은 요즘 잠에 들 때 평균적으로 얼마나 걸리나요?", {
                    "1~5분": (0, "수면 패턴이 안정적이며, 수면의 질이 높을 가능성이 큽니다."),
                    "30분~1시간": (1, "수면에 어려움이 있어 스트레스나 불안이 있을 수 있습니다."),
                    "2시간~4시간": (2, "심각한 수면 장애가 있으며, 이는 높은 스트레스와 불안을 시사할 수 있습니다."),
                }),
                ("나는 요즘 내가 하는 일에 불안감을 느낀다", {
                    "그런편이다.": (1, "현재 하는 일에 대한 불안감이 있으며, 이는 스트레스를 증가시킬 수 있습니다."),
                    "아니다.": (0, "현재 하는 일에 대한 안정감을 느끼며, 스트레스가 적습니다."),
                }),
                ("당신은 요즘 혼자라고 생각이 들 때가 있나요?", {
                    "그렇다.": (1, "외로움을 느끼고 있으며, 이는 정서적 지지 부족과 관련될 수 있습니다."),
                    "아니다.": (0, "외로움을 느끼지 않으며, 사회적 지지가 잘 형성되어 있습니다."),
                }),
                ("당신이 지내는 곳의 환경은 항상 정돈되어 있나요?(직장 혹은 집)", {
                    "정돈된 편이다.": (0, "생활 환경이 잘 정리되어 있으며, 이는 정신적 안정과 관련될 수 있습니다."),
                    "정리가 안 돼있다.": (1, "생활 환경이 어수선하며, 이는 스트레스와 관련될 수 있습니다."),
                }),
            ],
            "사회적 욕구": [
                ("당신은 힘들 때 주변에 조언을 구하는 편인가요?", {
                    "가족 혹은 친구에게 조언을 구하는 편이다.": (0, "사회적 지지 네트워크가 잘 형성되어 있어 스트레스 관리와 문제 해결에 도움을 받을 가능성이 큽니다."),
                    "혼자 해결하려고 하는 편이다.": (1, "립적이지만, 문제 해결 시 사회적 지원을 활용하지 않아 스트레스가 누적될 수 있습니다."),
                }),
                ("당신은 자신의 이야기를 타인에게 잘하는 편인가요", {
                    "대체적으로 잘하는 편이다.": (0, "개방적이고 소통이 잘 되는 성향으로, 감정을 공유하고 스트레스를 해소하는 데 긍정적입니다."),
                    "잘 이야기하지 않는다.": (1, "내성적이거나 신뢰할 만한 대화 상대가 부족할 수 있으며, 감정을 내면에 쌓아두는 경향이 있을 수 있습니다."),
                }),
                ("당신은 사람들과 있을 때 주로 하는 이야기는 어떤 것인가요?", {
                    "대체적으로 잘하는 편이다.": (0, "타인에 대한 관심이 많고 사회적 상호작용을 중요시하는 성향입니다."),
                    "잘 이야기하지 않는다.": (0, "자신에 대한 이야기를 많이 하여 자아중심적인 경향이 있을 수 있습니다."),
                }),
                ("당신은 주변 사람들의 행동과 말에 영향을 많이 받는 편인가요?", {
                    "그런편이다.": (1, "외부 환경에 민감하고 타인의 의견에 영향을 받기 쉬워 스트레스에 취약할 수 있습니다."),
                    "아니다.": (0, "자아가 확고하며 외부 영향을 덜 받습니다. 자신의 생각과 행동을 주도적으로 유지합니다."),
                }),
                ("당신은 기존에 알던 사람들 외에 관계를 더 이어가려고 하는 편인가요 그렇지 않은 편인가요?", {
                    "지금 사람들 외에 관계에서 사람들을 더 늘려가고 싶지 않다.": (0, "새로운 관계 형성에 소극적이며, 현재의 인간관계에 만족하는 경향이 있습니다."),
                    "새로운 사람과 인연을 만나는 건 즐겁다.": (0, "사회적 확장을 즐기고, 새로운 인간관계에 개방적입니다."),
                }),
                ("당신은 처음 만난 사람에게 먼저 말을 거는 편인가요?", {
                    "그런편이다.": (0, "사교적이며, 새로운 사람과의 상호작용을 즐깁니다."),
                    "아니다.": (1, "내성적이거나 처음 만난 사람과의 상호작용에 소극적입니다."),
                }),
                ("당신이 직장에서 일을 할 때 더 스트레스 받는 부분은 어떤 것인가요?", {
                    "직장동료들과의 관계": (1, "인간관계에서 오는 스트레스가 크며, 이는 업무 환경에서의 스트레스 요인으로 작용할 수 있습니다."),
                    "과도한 업무": (1, "업무량이 많아 스트레스를 느끼며, 이는 번아웃이나 업무 효율성 저하를 초래할 수 있습니다."),
                }),
                ("지금 현재 상황에 나에게 제일 중요한 우선순위는 무엇인가요?", {
                    "직장에서의 성과,취업 혹은 학업": (0, "현재 직업적 또는 학업적 성취와 발전이 최우선이며, 이로 인한 스트레스가 주요 관심사입니다."),
                    "연애,결혼,인간관계": (0, "개인적인 인간관계에서의 고민이나 연애, 결혼 문제 해결이 우선순위로, 이로 인한 스트레스가 주요 요인입니다."),
                }),
            ],
            # 기타 카테고리 설정
            "존경취득의 욕구": [
                ("주변에서 당신에게 기대를 많이 하는 편인가요?", {
                    "그런편이다.": (1, "높은 기대를 받으며, 이는 긍정적인 자극이 될 수 있지만 스트레스와 부담을 유발할 수도 있습니다."),
                    "아니다.": (1, "주변의 기대가 적어 스트레스는 덜하지만, 동기부여가 부족할 수 있습니다."),
                }),
                ("친구나 지인이 sns에 게시물을 업로드 했을 때 어떤 생각이 드나요?", {
                    "아무생각이 없다.": (0, "타인의 삶에 영향을 덜 받으며, 자신의 삶에 집중합니다."),
                    "이번 주에 나는 무엇을 했는지 생각한다.": (0, "타인의 삶과 비교하며 자극을 받아 자신의 삶을 돌아보는 성향이 있습니다."),
                    "SNS를 하지 않음.": (1, "SNS 활동을 하지 않으며, 타인의 게시물에 영향을 받지 않으나, 사회적 트렌드나 타인과의 연결에서 소외될 수 있습니다."),
                }),
                ("당신은 밖에서의 성격과 집에 있을 때 성격이 다른 편인가요?", {
                    "그렇다.": (1, "상황에 따라 성격이 달라지며, 이는 유연성과 적응력을 나타내지만 내적 갈등이 있을 수 있습니다."),
                    "아니다.": (0, "일관된 성격을 유지하며, 이는 안정성과 일관성을 나타냅니다."),
                }),
                ("주변의 기대에 못 미칠 때 드는 생각은 어떤 것인가요?", {
                    "상관없다.": (0, "타인의 기대에 덜 영향을 받으며, 자기주도적입니다."),
                    "조급하고 자존심이 상한다.": (1, "타인의 기대에 민감하며, 스트레스와 자존심 손상이 클 수 있습니다."),
                }),
                ("당신은 자신만의 기준이 높은 편인가요?", {
                    "그런편이다.": (1, "높은 자아 기준을 가지고 있어 자기 발전을 추구하지만, 스트레스와 압박감이 클 수 있습니다."),
                    "아니다.": (0, "자아 기준이 높지 않아 스트레스는 덜하지만, 동기부여가 부족할 수 있습니다."),
                }),
                ("당신은 일,시험 등 뜻대로 되지 않거나 실패,불합격 등에 어떻게 받아들이는 편인가요?", {
                    "좌절하는 감정이 크다.": (1, "실패에 대한 민감도가 높아 스트레스와 좌절감을 크게 느낍니다."),
                    "극복하려고 한다.": (0, "실패를 성장의 기회로 받아들이며, 회복탄력성이 높습니다."),
                }),
                ("당신은 중요한 계획이나(시험,취업 준비 등)일 때 주변 환경에 어떤 쪽으로 행동하나요?", {
                    "집중해야 하므로 예민한 상태이며, 사람들과의 연락을 잘 하지 않는다.": (1, "중요한 일에 집중하기 위해 사회적 상호작용을 줄이며, 이는 스트레스와 고립감을 유발할 수 있습니다."),
                    "평소와 변화는 없다.": (0, "일상과의 균형을 유지하며, 스트레스 관리가 잘 됩니다."),
                }),
                ("당신은 타인에게 의식을 많이 하는 편인가요?", {
                    "그런편이다.": (1, "타인의 평가와 의견에 민감하며, 이는 스트레스와 불안을 유발할 수 있습니다."),
                    "아니다.": (0, "타인의 평가에 덜 영향을 받으며, 자기 주도적입니다."),
                }),
            ],
            "자아실현의 욕구": [
                ("당신은 계획을 세울 때 주로 어떤 스타일인가요?", {
                    "미리 계획을 해두며 다른 대비책도 만들어 놓는 스타일.": (0, "철저한 계획성과 준비성을 가지고 있으며, 이는 불확실성에 대한 대비가 잘 되어 있음을 나타냅니다."),
                    "정해지지 않고 그때 상황마다 달라지는 스타일.": (0, "유연성과 적응력이 높으며, 상황에 따라 계획을 조정할 수 있는 능력을 가지고 있습니다."),
                }),
                ("나는 지금 상황에 만족하고 있다.", {
                    "그렇다.": (0, "현재 상황에 만족하며 긍정적인 삶의 태도를 가지고 있습니다. 이는 스트레스가 적고 심리적 안정감이 높을 수 있음을 의미합니다."),
                    "아니다.": (1, "현재 상황에 불만족하며 변화나 개선을 필요로 합니다. 이는 스트레스를 유발할 수 있으며, 변화에 대한 동기부여로 작용할 수 있습니다."),
                }),
                ("당신은 나에게 보상이 오지 않더라도 성취감을 느낄 수 있으면 보람을 느끼나요?.", {
                    "그렇다.": (0, "내적 동기와 성취감에 중점을 두며, 물질적 보상 없이도 만족감을 느낍니다."),
                    "그렇지 않다.": (0, "물질적 보상이나 외부 인정을 중시할 수 있습니다."),
                }),
                ("당신은 결과가 좋으면 과정은 별로 중요하지 않다고 생각하나요?.", {
                    "그렇다.": (0, "결과 중심적인 사고를 하며, 과정보다 결과를 중시합니다."),
                    "그렇지 않다.": (0, "과정의 중요성을 인식하며, 결과뿐만 아니라 과정도 중시합니다."),
                }),
                ("당신은 실패를 한 경험이 있나요?", {
                    "그렇다.": (0, "실패 경험이 있으며, 이는 성장의 기회로 삼을 수 있습니다. 하지만 실패에 대한 감정 처리 방식이 중요합니다."),
                    "그렇지 않다.": (0, "실패 경험이 없으며, 이는 도전이 부족했을 수 있습니다. 실패 경험이 없는 것은 반드시 긍정적인 것만은 아닙니다."),
                }),
                ("당신이 성취를 통해 얻는 보상심리 중 더 선호 하는 쪽은?", {
                    "자존감, 사회적 인정.": (0, "성취를 통해 자신의 가치와 능력을 인정받고자 하며, 이를 통해 자존감과 사회적 지위를 강화하려는 경향이 있습니다."),
                    "금전적 보상,": (0, "성취를 통해 실질적인 금전적 보상을 중시하며, 이를 통해 경제적 안정과 물질적 만족을 추구합니다."),
                }),
                ("나는 자기개발에 무리하더라도 투자하는 편이다.", {
                    "그런편이다.": (0, "자기개발에 대한 투자를 중요시하며, 이를 통해 개인적 성장과 역량 강화를 추구합니다. 이로 인해 일시적으로 부담이 될 수 있지만, 장기적인 성과를 기대합니다."),
                    "아니다.": (0, "자기개발에 무리하지 않으며, 현재의 생활과 균형을 중요시합니다. 이는 과도한 부담을 피하고 스트레스를 줄이는 데 도움이 될 수 있습니다."),
                }),
                ("당신은 현재가 중요한가요 미래가 중요한가요?", {
                    "현재가 중요": (0, "현재에 집중하며, 현재의 삶을 즐기고 만족감을 느낍니다."),
                    "미래가 중요": (0, "장기적인 계획과 목표를 중시하며, 미래에 대한 대비를 중요시합니다."),
                }),
            ],
            # 기타 카테고리 설정
        }

    def calculate_score(self, responses):
        total_score = 0
        category_scores = {category: 0 for category in self.questions}
        type_counter = {category: 0 for category in self.questions}  # 각 유형의 점수

        explanations = []

        for category, questions in self.questions.items():
            for question, options in questions:
                answer = responses.get(question, None)
                if answer and answer in options:
                    score, explanation = options[answer]
                    total_score += score
                    category_scores[category] += score
                    explanations.append(explanation)
                    if score > 0:  # 선택된 옵션이 점수가 있다면
                        type_counter[category] += 1

        return total_score, category_scores, explanations, type_counter

    def analyze_results(self, total_score, category_scores, explanations, type_counter):
        analysis = {}
        analysis["요약"] = "만족감" if total_score <= 5 else "불만족"

        primary_category = max(category_scores, key=category_scores.get)
        max_score = category_scores[primary_category]

        if max_score >= 5:
            if primary_category == "physiological":
                analysis["메인_카테고리"] = "생리적 욕구 부족. 건강한 식습관과 운동 습관 개선 필요."
            # 다른 카테고리 분석 추가 가능

        # 유형 결정
        most_common_type = max(type_counter, key=type_counter.get)
        if type_counter[most_common_type] > 3:  # 특정 유형의 질문이 5개 이상 선택된 경우
            analysis["유형"] = f"당신은 {most_common_type} 유형입니다."
        else:
            analysis["유형"] = "특정 유형이 뚜렷하지 않습니다."

        analysis["설명"] = explanations
        return analysis

@app.post("/submit", response_class=JSONResponse)
async def submit_survey(request: Request):
    try:
        responses = await request.json()
        analyzer = SurveyAnalyzer()
        total_score, category_scores, explanations, type_counter = analyzer.calculate_score(responses)
        analysis = analyzer.analyze_results(total_score, category_scores, explanations, type_counter)
        return JSONResponse(content={"analysis": analysis})
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)